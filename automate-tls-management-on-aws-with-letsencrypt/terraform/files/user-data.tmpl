#!/bin/bash
yum update -y
yum install -y python-pip golang jq
pip install --upgrade pip
pip install awscli
aws configure set preview.cloudfront true
mkdir $HOME/golang $HOME/.lego

aws sync s3://${domain}-lego-account/ $HOME/.lego/

export GOPATH=$HOME/golang
export PATH=$PATH:$GOPATH/bin
go get -u github.com/xenolf/lego

lego --email="${email}" --domains="${domain}" --domains="${san}" --dns="route53" --path $HOME/.lego renew

today=`date +%Y%d%m`
aws iam upload-server-certificate --server-certificate-name $${today}-cf-${domain} --certificate-body file://$HOME/.lego/certificates/${domain}.crt --private-key file://$HOME/.lego/certificates/${domain}.key --path /cloudfront/inge4pres/ > upload-output.txt
# Update Cert on API GW
# aws apigateway update-domain-name --domain-name ${domain} --patch-operations op='replace',path='/certificateName',value='/cloudfront/inge4pres/$${today}-cf-${domain}'

#aws cloudfront get-distribution-config --id ${cf_id} > CF_config_${cf_id}.json
#certid=$(cat upload-output.txt | jq -rc .ServerCertificateMetadata.ServerCertificateId)
#cat CF_config_${cf_id} | jq --arg CERTID $${certid} '.DistributionConfig.ViewerCertificate.IAMCertificateId |= $${certid}' | jq --arg CERTID $${certid} '.DistributionConfig.ViewerCertificate.Certificate |= $CERTID' > CF_config_update_${cf_id}.json
   
#aws cloudfront update-distribution --distribution-config file://CF_config_update_${cf_id}.json --id ${cf_id}
