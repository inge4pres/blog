<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>
    platform - inge4pres
  </title><meta name="generator" content="Hugo 0.98.0" /><link
    rel="stylesheet"
    href="https://inge.4pr.es/css/styles.css"
    integrity=""
  />
  
  <script>
    
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>
  
</head>

  <body
    class="flex flex-col min-h-screen dark:bg-gray-900 dark:text-gray-100 transition-colors duration-500"
  ><header class="w-full px-4 pt-4 max-w-5xl mx-auto">
  <nav class="flex items-center justify-between flex-wrap">
    <div class="flex gap-2 items-center">
      
      <a href="mailto:fgualazzi@gmail.com" aria-label="EMail">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <circle cx="12" cy="12" r="4" />
          <path d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28" />
        </svg>
      </a>
      
      <a href="https://inge.4pr.es/" class="flex items-center font-bold">
        inge4pres
      </a>
    </div>

    <ul id="nav-menu" class="flex w-auto mt-0 space-x-2">
      
      <li>
        <a href="https://inge.4pr.es/about/" class="hover:text-blue-800 dark:hover:text-blue-300">You are what you is (F. Zappa)</a>
      </li>
      
      
      <li>
        <a href="https://inge.4pr.es/categories/blog/" class="hover:text-blue-800 dark:hover:text-blue-300">blog</a>
      </li>
      
    </ul>
  </nav>
</header>
<main class="flex-1 mx-4 md:mx-12 lg:mx-24 mt-8 sm:mt-16"> 
<article class="sm:mx-12 mb-16 prose lg:prose-lg">
  <h1><a href="https://inge.4pr.es/post/progressive-delivery-with-kubernetes/">Progressive Delivery with Kubernetes</a></h1>
  <p>I&rsquo;m more and more fond of finding the perfect solution to manage application delivery: dev teams want to be fast but their ops counterpart is not happy to loose control over the growing number of deployments that could cause an outage. We as an industry need to find the right balance to have features delivered in time and keep the service up and running for our users! And that&rsquo;s where progressive delivery can help!</p>
<p>What is progressive delivery? It&rsquo;s the evolution of continuous integration and continuous delivery practices, taken to the extreme - if this is the first time you hear about it, read <a href="https://redmonk.com/jgovernor/2018/08/06/towards-progressive-delivery/">this excellent post by James Governon</a>. But as of today what are the tools that embed this practice in deployment pipelines? None that I could find ☹️&hellip; hence I started this post to share some of the techniques that you can use to achieve progresive delivery today on Kubernetes! I&rsquo;d be really glad to have any comments and discuss on the matter.</p>
<h3 id="the-goal">The goal</h3>
<p>The progressive delivery manifesto (if there will ever be one) should explain the rationale why delivering feature in parts is better than all at once: feedback.
In this Agile world feedback is everything, and the only feedback that matters is your users&rsquo;; as Jez Humble puts it</p>
<blockquote>
<p>“Users don’t know what they want. Users know what they don’t want once you’ve built it for them.”</p>
</blockquote>
<p>You are not going to build anything useful if you don&rsquo;t collect your users opinion <em>while</em> building the product, that is why having a system that is able to change quickly and that can collect this feedback is so vital to success.</p>
<h3 id="to-mesh-or-not-to-mesh">To mesh or not to mesh</h3>
<p>The first approach to progressive delivery is via infrastructure components.
I cheated a bit in the post intro: there actually is a tool combination that is able to implement a feature close to progressive delivery right now: it&rsquo;s <a href="https://istio.io/">Istio</a> plus <a href="https://www.spinnaker.io/">Spinnaker</a>; the network mesh in this scenario is a router for connections originating by clients between multiple versions of the same backend, whose deployed versions are managed by Spinnaker releases. The mesh could be another product (Envoy, Linkerd, Consul Connect&hellip;) but it is the necessary component that contains the logic to serve the user a specific version of the application, based on goegraphic location rules, latency or even application rules (layer 7).</p>
<p>If you want to avoid the burden of installing and maintaining a mesh network you need to manage custom tooling to have the traffic routed for a subset of users to a specific version, <a href="https://github.com/bookingcom/shipper">Skipper</a> is a good example but comes with the restriction of not being able to manage percentage of traffic, so the percentage of user served is based only on the number of pods configured from service to service (so not ideal for small sized deployments).</p>
<p>The other way I see right now is creating a <a href="/2018/05/05/cloud-native-software-delivery/">Kubernetes operator and a CustomResourceDefinition</a> that can interact with the Ingress resource: this is hypothetical and I am not aware of any tool that is doing this but it could be posible to configure the ingresses to serve part of the requests by a specific Service (e.g. <code>v1.2.3</code> backed by a Deployment with a proper <code>selector</code>). As far as I know the current ingress controler based on nginx does not have such feature, but I just discovered writing this line that <a href="https://docs.traefik.io/user-guide/kubernetes/#traffic-splitting">Traefik does support this</a>! It would be great to understand if Traefik can manage multiple rules at once and if it can be managed via API so that the traffic is gradually moved from service to service.</p>
<h3 id="feature-flags">Feature flags</h3>
<p>Of course if you move to the application things get easier in terms of programmability, problem is they tend to be more difficult to manage at scale. If you use one of the <a href="http://featureflags.io/feature-flags/">multitude of available</a> feature-flag products (also referred as <a href="https://www.martinfowler.com/articles/feature-toggles.html">feature toggles</a>) you are soon going to be able to experiment with progressive delivery capabilities; your application will most likely contain the logic required to show a specific user a feature or another. While this is intriguing, if you have more than 2 product teams this can easily become a nightmare because if each team implements its own solution of feature toggle the company as a whole can really struggle to get what type of experience is serving to its users. Change management, for as light as it can be, should still be accounting for features enabled and disabled that may cause a service disuption, even if for a small percentage of users, and when the logic for serving different versions of your system is scattered around multiple applications, this goes quickly out of control.</p>
<p>One approach I&rsquo;ve seen succeed in using software-defined toggle is adopt a centralized, company-wide solution around an existing product: this simplifies greatly the management around features that are delivered passing through multiple services while being able to keep track of changes consitently.</p>
<h3 id="delivering-it">Delivering it</h3>
<p>Once you&rsquo;ve established an infrastructure for serving users based on some policies you should also have in place automation to be able to push your features out. In case you went for the infrastructure/network path you&rsquo;ll need a deployment tool that can sit between your CI artifacts and the platform running your services; on the contrary for a software-driven solution you will just need an application build and deployed regularly.
For the former I am really struggling to find a product that suites my need, I&rsquo;ve poked around with Spinnaker, ArgoCD and Tekton Pipelines but none of them seems to have the adequate primitives to address my progressive delivery needs.
I&rsquo;d be happy to hear from the community how this is being addressed: I&rsquo;d like to have a descriptive way of defining multiple versions of artifacts and configurations paired together (maybe via commit hash?) and have all of them deployed at the same time; I&rsquo;d also like to update the configurations of a given version while it&rsquo;s running.</p>
<p>Seems fair right? I might need to tweak my service here and there, but I&rsquo;d like to tune it only for a specific set of features that I know are in version ABC. Now I could not find on the internet a single product that works with Kubernetes able to satisfy this requirement, so please if you happen to have something in mind leave a comment!</p>
<h3 id="conclusion">Conclusion</h3>
<p>As always Kubernetes is a great enabler for delivery techniques based on software, it&rsquo;s an extensible platform and the multiple uses that can lead to achieve progressive delivery just confirm it. Personally I see a lot of space for progressive delivery in the upcoming future, especially for IoT. Let&rsquo;s see what&rsquo;s next!</p>

</article>

<article class="sm:mx-12 mb-16 prose lg:prose-lg">
  <h1><a href="https://inge.4pr.es/post/cloud-native-software-delivery/">Cloud-native applications: Operator-Framework</a></h1>
  <p><strong>Cloud-native</strong>: sounds attractive right? What does it even mean? <a href="https://en.wikipedia.org/wiki/Cloud-native">Wikipedia</a> has no page on it already so anyone can give its own definition&hellip; Here&rsquo;s mine:</p>
<p><em>A Cloud-native application has only concern on the functionalities that it has to deliver as it is completely decoupled from the infrastructure it runs on</em></p>
<p>So how can software delivery be cloud-native? Isn&rsquo;t software delivery supposed to &ldquo;install&rdquo; software onto some infrastructure? Well if your infrastructure provider <em>is</em> cloud-native, you can transitively deliver software on it in a cloud-native way (counts of cloud-native is over 9000, so stopping here)!</p>
<p>Recently RedHat acquired CoreOS, bold move if you ask me. CoreOS since the M&amp;A has been very quite until a week ago when the <a href="https://github.com/operator-framework">operator-framework</a> was announced through a <a href="https://coreos.com/blog/introducing-operator-framework">blog post</a>; this is a huge step forward for everyone as this new toolkit will empower the average developer with the ability to run operators on Kubernetes and package their applications as extensions to the Kubernetes API.</p>
<p>Never heard of <a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/#customresourcedefinitions">Custom Resource Definitions</a>? You&rsquo;d better get on track as this will be driving the next-gen wave of applications that will run <em>as part</em> of the platform that delivers them, with the ability to automate their management and simplify dramatically their operations which will be tightly integrated with the cluster management itself.</p>
<p>And as usual I&rsquo;m eager to try out this new toy and see what can be done with it: I want to build a cloud-native software delivery application that will enable CI/CD jobs to be running inside the cluster and managed by the same API server! Using a CRD for the &ldquo;Pipeline&rdquo; kind I can control the build/test/release flow of my application and moreover monitor the whole thing with the same tools with which I will monitor my application.</p>
<h3 id="creating-cd">Creating CD³</h3>
<p>I decided to start a new project called <a href="https://github.com/inge4pres/cdkube">CD³ (cd kube)</a>: it will be a Continuous-* software that will run in Kubernetes and will be dedicated to deliver software <em>through</em> Kubernetes. I found Weaveworks did something similar with <a href="https://github.com/weaveworks/flux/">Flux</a> and since I don&rsquo;t want to reinvent the wheel I&rsquo;ll just try and replicate some functionality of running a continer in an operator.</p>
<p>First things first: I installed the <a href="https://github.com/operator-framework/operator-sdk">operator-sdk</a> and I have the binary in my <code>$GOPATH/bin</code>.
Running</p>
<pre tabindex="0"><code>$GOPATH/bin/operator-sdk new cdkube --api-version=delivery.inge.4pr.es/v1alpha1 --kind=Pipeline
</code></pre><p>I am resulting in an auto-generated project with some scaffold code, as in <a href="https://github.com/inge4pres/cdkube/commit/bd7a1cf8790cf02169057f759e40272993673181">this commit</a>.
Next I add some details which I think are at the core of a pipeline: the repository with code and configurations, the image to build the software and what version/name give to the resulting application artifact. When adding new items to the Spec and Status of CRD I will modify the <a href="https://github.com/inge4pres/cdkube/blob/master/pkg/apis/delivery/v1alpha1/types.go">pkg/apis/delivery/v1alpha1/types.go</a> file, then the guide suggests to run <code>operator-sdk generate k8s</code> to update the code, in fact the <code>zz_generated_deepcopy.go</code> is updated, but I don&rsquo;t see the <a href="https://github.com/inge4pres/cdkube/commit/5a17429d206475bcef85077d1f9aeb6fdda50357#diff-5cd8fbaa4e3fbb473c3e57c6fabca2f9">deploy/cr.yaml</a> changed as it should so probably there&rsquo;s a bug&hellip; Moving forward I have my operator logic to be defined now: I add some check whether the building pod is succeded and build the operator</p>
<pre tabindex="0"><code>operator-sdk build inge4pres/cdkube:v0.0.1
docker push inge4pres/cdkube:v0.0.1
</code></pre><p>My operator is built, pushed to dockerhub and ready to be kicked in a k8s cluster, so I fire up one in GKE</p>
<pre tabindex="0"><code>gcloud beta container --project &#34;inge4pres-gcp&#34; clusters create &#34;operator-framework-test&#34; --zone &#34;europe-west1-b&#34; --machine-type &#34;g1-small&#34; --image-type &#34;COS&#34; --disk-size &#34;25&#34;

gcloud container clusters get-credentials operator-framework-test --zone europe-west1-b --project inge4pres-gcp
</code></pre><p>and when it&rsquo;s ready I can deploy the auto-generated resources to the cluster.
An amazing result is that once the depoloyment is done I can create my CRD with the <code>kubectl</code> command and see my custom-type declared, running <code>kubectl create -f deploy/crd.yaml</code> I have a new object created in k8s</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ kubectl get pipeline
</span></span><span style="display:flex;"><span>NAME            AGE
</span></span><span style="display:flex;"><span>doing-nothing   16s
</span></span><span style="display:flex;"><span>➜  ~ kubectl describe pipeline
</span></span><span style="display:flex;"><span>Name:         doing-nothing
</span></span><span style="display:flex;"><span>Namespace:    default
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>API Version:  delivery.inge.4pr.es/v1alpha1
</span></span><span style="display:flex;"><span>Kind:         Pipeline
</span></span><span style="display:flex;"><span>Metadata:
</span></span><span style="display:flex;"><span>  Cluster Name:
</span></span><span style="display:flex;"><span>  Creation Timestamp:             2018-05-05T18:08:31Z
</span></span><span style="display:flex;"><span>  Deletion Grace Period Seconds:  &lt;nil&gt;
</span></span><span style="display:flex;"><span>  Deletion Timestamp:             &lt;nil&gt;
</span></span><span style="display:flex;"><span>  Initializers:                   &lt;nil&gt;
</span></span><span style="display:flex;"><span>  Resource Version:               <span style="color:#bd93f9">1528</span>
</span></span><span style="display:flex;"><span>  Self Link:                      /apis/delivery.inge.4pr.es/v1alpha1/namespaces/default/pipelines/doing-nothing
</span></span><span style="display:flex;"><span>  UID:                            5160a990-508f-11e8-8f06-42010a8401f8
</span></span><span style="display:flex;"><span>Spec:
</span></span><span style="display:flex;"><span>Spec:
</span></span><span style="display:flex;"><span>  Build Arguments:
</span></span><span style="display:flex;"><span>    building something...
</span></span><span style="display:flex;"><span>    now I&#39;m <span style="color:#ff79c6">done</span>
</span></span><span style="display:flex;"><span>  Build Commands:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">echo</span>
</span></span><span style="display:flex;"><span>  Build Image:     busybox
</span></span><span style="display:flex;"><span>  Repo:            http://github.com/inge4pres/just-a-test
</span></span><span style="display:flex;"><span>  Target Name:     tesApp
</span></span><span style="display:flex;"><span>  Target Version:  0.1
</span></span><span style="display:flex;"><span>Events:            &lt;none&gt;
</span></span><span style="display:flex;"><span>➜  ~</span></span></code></pre></div>
<p>When I deploy my operator and create the custom resource applying the manifest for a pipeline, the operator picks it up and starts a container with the name of the pipeline</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl apply -f deploy/cr.yaml
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl get po
</span></span><span style="display:flex;"><span>NAME                      READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>cdkube-57bcf65584-sbvd6   1/1       Running   <span style="color:#bd93f9">0</span>          12s
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl apply -f deploy/cr.yaml
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f1fa8c">&#34;doing-nothing&#34;</span> created
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl get po
</span></span><span style="display:flex;"><span>NAME                      READY     STATUS              RESTARTS   AGE
</span></span><span style="display:flex;"><span>cdkube-57bcf65584-sbvd6   1/1       Running             <span style="color:#bd93f9">0</span>          29s
</span></span><span style="display:flex;"><span>testapp                   0/1       ContainerCreating   <span style="color:#bd93f9">0</span>          2s
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl logs cdkube-57bcf65584-sbvd6
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:42:59Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Go Version: go1.10.2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:42:59Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Go OS/Arch: linux/amd64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:42:59Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;operator-sdk Version: 0.0.5+git&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:42:59Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;starting pipelines controller&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:43:21Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;build still running, status of builder container: Pending&#34;</span>
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl get po
</span></span><span style="display:flex;"><span>NAME                      READY     STATUS      RESTARTS   AGE
</span></span><span style="display:flex;"><span>cdkube-57bcf65584-sbvd6   1/1       Running     <span style="color:#bd93f9">0</span>          49s
</span></span><span style="display:flex;"><span>testapp                   0/1       Completed   <span style="color:#bd93f9">2</span>          22s</span></span></code></pre></div>
<p>and if I get the <code>testapp</code> logs I can see the pipeline execution</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl logs testapp
</span></span><span style="display:flex;"><span>building something... now I&#39;m <span style="color:#ff79c6">done</span></span></span></code></pre></div>
<p>Bonus: if the custom resource is deleted with <code>kubectl delete -f deploy/cr.yaml</code> the pod <code>testapp</code> gets terminated automatically! I don&rsquo;t know if this magic is done by Kubernetes or by the Operator Framework, but sure I love it as it will enable my resources to be managed with the k8s API just like any other.</p>
<p>I still need to tune the logic of handling the container as I didn&rsquo;t expect the restarts to happen, but hey this looks amazing! In a couple of hours I have an operator that can spawn containers when instructed to do so by custom manifests representing a pipeline!</p>
<p>Stay tuned 😎</p>

</article>

<article class="sm:mx-12 mb-16 prose lg:prose-lg">
  <h1><a href="https://inge.4pr.es/post/continuous-delivery-with-drone/">Continuous Delivery with Drone</a></h1>
  <p>Continuous Delivery should be a solved issue: the practice is well-defined and there is a plethora of tools implementing it with more or less peculiarities, but still many struggle implementing it. The dream of a perfect continuous deployment flow from the developer to the production environment with software quality gates based on automated tests is still alive in me, I tried and tried several times with multiple implementations on multiple platforms and never got to the point where I could say: &ldquo;I&rsquo;m done, this works exactly as I wanted&rdquo;.</p>
<p>So I stumbled on <a href="https://drone.io">drone</a> and decided to give it a go: it&rsquo;s an open-source project, written in Go and with a SaaS offering via their website. The concept I like is that every step of the build/deployment process runs through a container and this is very close to my idea of a modern CD tool, a platform where I can compose pipelines by chaining containers execution on a shared workspace. Love it already.</p>
<h3 id="installing-the-stack">Installing the stack</h3>
<p>You can run the drone server and agent locally on your laptop with <code>docker-compose</code> as detailed <a href="http://docs.drone.io/installation/">here</a>. Only issue is: for integrating with any of the big Git cloud provider (Github and Gitlab) you will need to expose your service to the internet, so I&rsquo;ll use a local instance of <a href="https://gogs.io/">gogs</a> running in a docker container from the <a href="https://github.com/gogits/gogs/tree/master/docker">official image</a>. All I need is in the <code>docker-compose.yml</code> file: I added just a couple of <code>volumes</code> directive compared to the <a href="http://docs.drone.io/install-for-gogs/">original one</a> and I am using the docker-for-mac internal hostname to resolve the bridge IP internally as detailed <a href="https://docs.docker.com/docker-for-mac/networking/#use-cases-and-workarounds">here</a>. This is a lab setup and having a production-ready installation will require database setup and filesystem persistence, but I don&rsquo;t have this requirement now. After a <code>docker-compose up -d</code> my stack is ready.</p>
<h4 id="installing-the-cli">Installing the CLI</h4>
<p>As easy as following <a href="http://docs.drone.io/cli-installation/">this guide</a>. Once logged to the web UI I navigate to the <code>${DRONE_HOST}/account/token</code> page where I can get a token to configure the CLI.</p>
<h3 id="adding-secrets">Adding secrets</h3>
<p>There is a nice feature in drone: I can <a href="http://docs.drone.io/manage-secrets/">manage secrets</a> directly from the command line and they can be scoped globally or be available only to one pipeline step (corresponding to an image). I will need to add Dockerhub username and password to the <code>plugin/docker</code> image to be able to push the image, so I add this 2 secrets with the following</p>
<pre tabindex="0"><code>drone secret add -repository=inge/goapp -image=plugins/docker -name=docker_username -value=inge4pres
drone secret add -repository=inge/goapp -image=plugins/docker -name=docker_password -value=***************
</code></pre><h3 id="a-sample-pipeline">A sample pipeline</h3>
<p>As many of the continuous delivery tools available on the market, drone uses a YAML configuration file in the root of the repository, so adding a <code>.drone.yml</code> hidden file is enough to start hooking every commit to the build system. I configured a <a href="https://github.com/inge4pres/blog/blob/master/continuous-delivery-with-drone/test-app/.drone.yml">3 stages pipeline</a>:</p>
<ul>
<li>test and build artifact</li>
<li>publish the artifact</li>
<li>deploy the application</li>
</ul>
<p>It&rsquo;s very simple to get started and the one-container-per-step architecture makes it trivial to glue together multiple steps. There is an implicit concept of <a href="http://docs.drone.io/workspace/">shared workspace (configurable)</a> that you can leverage to use Makefile and Dockerfile just as the build was happening on your local environment.</p>
<p>So I really recommend trying out drone and reporting some issues if you find any, for the time being I am very excited to have a CD product entirely written in Go - I think I will contribute to the project to have some enhancements available in the free version.</p>
<p>Below here some screenshots of the drone web UI and the pipeline resulting from the YAML config file: I will explore more complex workflows like <a href="http://docs.drone.io/promoting-builds/">promoted builds</a> and <a href="http://docs.drone.io/gated-builds/">gated builds</a> - and build more in the tool if I need.</p>
<figure><img src="https://raw.githubusercontent.com/inge4pres/blog/master/continuous-delivery-with-drone/screenshots/drone-local.jpeg"/><figcaption>
            <h4>drone repository view</h4>
        </figcaption>
</figure>

<figure><img src="https://raw.githubusercontent.com/inge4pres/blog/master/continuous-delivery-with-drone/screenshots/drone-detail.jpeg"/><figcaption>
            <h4>drone pipeline log</h4>
        </figcaption>
</figure>

<figure><img src="https://raw.githubusercontent.com/inge4pres/blog/master/continuous-delivery-with-drone/screenshots/drone-error.jpeg"/><figcaption>
            <h4>drone stage error</h4>
        </figcaption>
</figure>

<figure><img src="https://raw.githubusercontent.com/inge4pres/blog/master/continuous-delivery-with-drone/screenshots/drone-running.jpeg"/><figcaption>
            <h4>drone running</h4>
        </figcaption>
</figure>


</article>

<article class="sm:mx-12 mb-16 prose lg:prose-lg">
  <h1><a href="https://inge.4pr.es/post/serverless-on-kubernetes/">Serverless on Kubernetes</a></h1>
  <p>Kubernetes is the <em>de facto</em> platform for running modern applications: its broad adoption in 2017 and the velocity of the project made it so and it&rsquo;s been accepted as the standard for many companies, from small to planet scale. It was impossible that such an extensible platform would be left out the serverless party, so here are the 4 main players offering FaaS to be run via k8s.</p>
<h3 id="a-premise">A premise</h3>
<p>If you&rsquo;re new to serverless and FaaS and all the previous buzzwords sound like cacophony to your ears, I really recommend reading <a href="https://martinfowler.com/articles/serverless.html">this post</a> and watching <a href="https://www.youtube.com/watch?v=LAWjdZYrUgI">this talk</a>. You could also notice how I put FaaS and serverless under the same hat here, this is just a personal opinion although some might argue that FaaS is a subset of serverless: historically I approached the serverless world using AWS Lambda, and I really tied the idea of writing functions and let someone else manage the infrastructure to the <em>serverless</em> concept. Also Sam Newman gave a <a href="https://youtu.be/CrS0HVQZiQI">good talk on serverless</a> that I really recommend watching.</p>
<h3 id="why-serverless-on-k8s">Why serverless on k8s</h3>
<p>It seems like a natural evolution for distributed systems to be composed by smaller and smaller parts. When moving from SOA to microservices the size of the service was reduced to enable development of more fine-grained functionalities into smaller and more maintainable components; taken to the extreme, you can reduce a microservice to be dedicated to just one task or to be  made of just one function, that&rsquo;s where FaaS fits into. Kubernetes is a great activator for such modularity as it creates a very powerful abstraction over infrastructure, so when developing a function as a separate module of a distributed system you can scale both vertically and horizontally any building block, each one independently from another, or you could even let Kubernetes manage that (think <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">Horizontal Pod Autoscaler</a>).</p>
<h3 id="four-players-offering-faas-on-k8s">Four players offering FaaS on k8s</h3>
<ul>
<li><a href="https://github.com/openfaas/faas">OpenFaaS</a></li>
<li><a href="https://github.com/fission/fission">Fission</a></li>
<li><a href="https://github.com/kubeless/kubeless">Kubeless</a></li>
<li><a href="https://github.com/fnproject/fn">Fn Project</a></li>
</ul>
<p>Now there might be others, but this 4 are the ones I mostly heard of in the last 6 months, so they must be the right ones 😁.</p>
<h4 id="comparison-criteria">Comparison criteria</h4>
<p>This is not a technical benchmark on the capabilities of this 4 frameworks: it&rsquo;s a <em>&ldquo;look Ma, I can serverless on k8s&rdquo;</em> post where I try and highlight the pros and cons of adopting one or the other; the criteria will be  installation methodology (client and server), languages support, cluster interoperability and developer experience, voted from 0 to 5 the higher the better.
I will use Kubernetes 1.8.6 that is, at the moment of writing, the latest available stable version.</p>
<p>The target function to deploy will be a super-serious analytics and business intelligence tool that will read the incoming HTTP request body and save it in a JSON document alongside with a timestamp. The JSON will be stored on a REDIS using a random UUIDv4 as key. All the code that will be deployed as functions is in <a href="https://github.com/inge4pres/blog/tree/master/serverless-on-kubernetes">Github</a>, while for installing the GCP cluster and REDIS I used the following</p>
<pre tabindex="0"><code>gcloud beta container --project &#34;${GCP_PROJECT}&#34; clusters create &#34;serverless-k8s&#34; \
  --zone &#34;europe-west2-c&#34; --username &#34;admin&#34; --cluster-version &#34;1.8.6-gke.0&#34; \
  --machine-type &#34;g1-small&#34; --image-type &#34;COS&#34; --disk-size &#34;50&#34; --num-nodes &#34;3&#34;

gcloud container clusters get-credentials serverless-k8s \
  --zone europe-west2-c --project &#34;${GCP_PROJECT}&#34;

helm init

helm install stable/redis
</code></pre><h4 id="fn-project">Fn Project</h4>
<h6 id="features">Features</h6>
<ul>
<li>function configuration via YAML</li>
<li>local development server via <code>fn start</code> and <code>fn run</code></li>
<li>uses DockerHub to store functions as containers</li>
<li>web UI with function monitoring</li>
</ul>
<h6 id="client-installation-4">Client installation: 4</h6>
<p>The <a href="https://github.com/fnproject/fn#install-cli-tool">installation instructions</a> are easy to read and execute, multiple platforms supported out of the box. User is required to set an environment variable with a DockerHub handle</p>
<pre tabindex="0"><code>export FN_REGISTRY=&lt;DOCKERHUB_USERNAME&gt;
</code></pre><h6 id="server-installation-3">Server installation: 3</h6>
<p>A Helm chart is provided under <a href="https://github.com/fnproject/fn-helm">fn-helm</a> but it&rsquo;s not immediately linked to the project&rsquo;s page. The installation requires the user to export an environment variable with the command</p>
<pre tabindex="0"><code>export FN_API_URL=http://$(kubectl get svc --namespace default fn-release-fn-api -o jsonpath=&#39;{.status.loadBalancer.ingress[0].ip}&#39;):80
</code></pre><h6 id="language-support-5">Language support: 5</h6>
<p>Built-in support for Java, Ruby, Go, Python. Runs any docker container as a function.</p>
<h6 id="cluster-interoperability-2">Cluster interoperability: 2</h6>
<p>It requires a LoadBalancer resource, so you won&rsquo;t be able to run it on <code>minikube</code> out of the box. It has MySQL and REDIS as dependency services and uses a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">DaemonSet</a> for the API controller, which might impact node&rsquo;s performance. No monitoring provided for the in-cluster components.</p>
<h6 id="developer-experience-3">Developer experience: 3</h6>
<p>Very extensive CLI interface. Functions are pipes: they should read Stdin and write to Stdout; some environment variables are injected to the running code to detect request URL and other configurations. I was able to complete my function deployment in roughly 1 hour after digging the docs a while to find out how to add custom configurations to the functions via environment variables.</p>
<h4 id="openfaas">OpenFaaS</h4>
<h6 id="features-1">Features</h6>
<ul>
<li>sponsored by CNCF</li>
<li>function grouping configuration via YAML (<a href="https://github.com/openfaas/faas-cli#use-a-yaml-stack-file">stack file</a>)</li>
<li>public function repository</li>
<li>Web UI with function monitoring</li>
<li>runs any docker container as a function</li>
</ul>
<h6 id="client-installation-2">Client installation: 2</h6>
<p>The <a href="https://github.com/openfaas/faas-cli#get-started-install-the-cli">CLI installation</a> is straight-forward for Linux and Mac users but it&rsquo;s not immediately available for Windows. I cannot find an easy way to set the cluster address to point the CLI to.</p>
<h6 id="server-installation-1">Server installation: 1</h6>
<p>Helm chart provided under <a href="https://github.com/openfaas/faas-netes/blob/master/HELM.md">faas-netes/helm</a> but it&rsquo;s failing the first time because of RBAC property not set and not rolling back, so I&rsquo;m forced to delete and recreate the release.
Even when installation is completed I cannot connect to the FaaS gateway as the service NodePort 31112, and the LoadBalancer creation errors out with</p>
<pre tabindex="0"><code>Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply
The Service &#34;gateway&#34; is invalid: spec.ports[0].nodePort: Invalid value: 31112: provided port is already allocated
</code></pre><h6 id="language-support-5-1">Language support: 5</h6>
<p>Built-in support for NodeJS, Ruby, Go, Python, C#, generic Dockerfile. Runs any docker container as a function.</p>
<h6 id="cluster-interoperability-4">Cluster interoperability: 4</h6>
<p>OpenFaas provides Prometheus monitoring with alerting out of the box, plus the architecture is very lean: just 2 pods that serve the API gateway and the function runner. Each function runs as a <code>Deployment</code> object and therefore can be scaled independently.</p>
<h6 id="developer-experience-2">Developer experience: 2</h6>
<p>After 2 hours trying to complete the setup on Kubernetes I&rsquo;m still not able to run any function on my cluster; I run a port-froward to the OpenFaaS gateway <code>kubectl port-forward gateway-pod-id 31112:8080</code> so I can run <code>faas-cli deploy -f samples.yml --gateway http://127.0.0.1:31112</code> inside the just cloned <code>faas-cli</code> repository and see some function in action.</p>
<h4 id="fission">Fission</h4>
<h6 id="features-2">Features</h6>
<ul>
<li>only 100ms function cold start (more on the topic <a href="https://serverless.com/blog/keep-your-lambdas-warm/">here</a>)</li>
<li>natively built for Kubernetes</li>
</ul>
<h6 id="client-installation-3">Client installation: 3</h6>
<p><a href="http://fission.io/docs/0.4.0/installation/#install-the-fission-cli">Guide</a> suggests to download a binary distribution via <code>curl</code> and place the binary§ under <code>/usr/local/bin</code>, very straightforward for Linux and OSX. Windows support is via WSL or using a binary <code>fission.exe</code> with download link provided. Some environment variables need to be setup to point to the cluster, but the <a href="http://fission.io/docs/0.4.0/installation/#cloud-setups">instructions</a> are very well written.</p>
<h6 id="server-installation-5">Server installation: 5</h6>
<p><a href="http://fission.io/docs/0.4.0/installation/#cloud-hosted-clusters-gke-aws-azure-etc">Also guide</a>: a single <code>helm</code> command installs all the components in a dedicated namespace <code>fission</code>.</p>
<h6 id="language-support-4">Language support: 4</h6>
<p>Built-in support for Linux binaries, Go, .NET, NodeJS, Perl, PHP 7, Python 3, Ruby as reported in the <a href="https://github.com/fission/fission#fission-concepts">concepts section</a>. Custom environment can be built and pushed to the cluster as containers.</p>
<h6 id="cluster-interoperability-2-1">Cluster interoperability: 2</h6>
<p>No monitoring at all and no UI provided to verify the functions state of execution or list, CLI is the only source of truth I can get and it&rsquo;s not easy to understand the architecture.</p>
<h6 id="developer-experience-2-1">Developer experience: 2</h6>
<p>Setup is very straightforward but then the development looks cumbersome (at least for Go): environment variables <a href="https://github.com/fission/fission/issues/356">cannot be set</a> yet, so this means hard-coded values in the code to connect to external services. Plus logging and function debugging is really hard, after 1 hour digging in documentation and trying to understand a cryptic <code>Internal server error (fission)</code> message, I am not able to run my Go function, and it&rsquo;s tough to tell why.</p>
<h4 id="kubeless">Kubeless</h4>
<h6 id="features-3">Features</h6>
<ul>
<li>natively built for kubernetes</li>
<li>web UI with function monitoring</li>
<li><a href="https://github.com/serverless/serverless-kubeless">serverless framework plugin</a> available</li>
</ul>
<h6 id="client-installation-5">Client installation: 5</h6>
<p>Binary distribution available for Linux, OSX and Windows in <a href="https://github.com/kubeless/kubeless/releases">Github release page</a>. No fuss, no hassle: download and run.</p>
<h6 id="server-installation-3-1">Server installation: 3</h6>
<p><a href="https://github.com/kubeless/kubeless#installation">Documentation</a> warns to create a namespace <code>kubeless</code> and use that. Same release page offers 3 options to install: Kubernetes with or without RBAC and Openshift. Applying the YAML with <code>kubectl apply -f kubeless-...</code> gets the server part up and running, but if I&rsquo;d like to install in a different namespace I would need to change the whole file. Providing a Helm chart is the standard Kubernetes packaging way so why not having one?</p>
<h6 id="language-support-3">Language support: 3</h6>
<p>Currently only Python, NodeJS, Ruby and .NET Core are supported. <a href="https://github.com/kubeless/kubeless/blob/master/docs/runtimes.md#custom-runtime-alpha">Custom runtimes</a> in the form of docker containers need to be built to run other languages, a feature in alpha which I&rsquo;m forced to explore to run my Go app.</p>
<h6 id="cluster-interoperability-4-1">Cluster interoperability: 4</h6>
<p>Monitoring provided via Prometheus integration; all backend services are run into dedicated namespace while functions are exposed using regular namespaces. It uses a StatefulSet to host Kafka and Zookeeper, they keep the functions state and there is a controller talking with Kubernetes API. I really like that it leverages Kubernetes-native primitives such as <code>ConfigMaps</code> and <code>Secrets</code> to manage function environment. It also uses a <code>CustomResourceDefinition</code> called <code>functions</code> so you can <code>kubectl get functions -o yaml</code>. What I don&rsquo;t like instead is the use of the cluster&rsquo;s etcd to store functions code when deploying from file.</p>
<h6 id="developer-experience-5">Developer experience: 5</h6>
<p>Everything worked great even when running an experimental feature such as custom environment: I was able to inject configuration via environment variables, get the function logs either via <code>kubeless</code> CLI or <code>kubectl</code> and debug my way out of the configuration error I put into my first image. Second deploy I did I was able to call my function and I validated the results connecting to REDIS afterwards.</p>
<h3 id="wrapping-up">Wrapping up</h3>
<p>There are lots of people investing in serverless right now, almost as many as there are for Kubernetes; the integrations between the two will bring a new exciting technology scenario in the next years. To my experience building this post none of the previously listed framework is ready for production usage, to be honest most of them are not even ready for the average developer weekend project usage. You need to know Kubernetes quite a bit to troubleshoot issues happening during deployment and/or execution of your functions and this makes the whole serverless idea crumble, as you&rsquo;ll be forced to dig into infrastructure details to have your code running.</p>
<p>If I&rsquo;d have to bet on one of the project I tried so far, I&rsquo;d do so on Kubeless; it&rsquo;s been definitely the smoothest setup  among all and the tight Kubernetes integration makes it a perfect candidate for community-driven growth. If you know any other framework that should be in this post please let me know it in the comments! I am always curious to see what&rsquo;s around in all things serverless so don&rsquo;t keep it for yourself!</p>

</article>
 
    </main><footer class="w-full text-center p-4 text-xs text-gray-400">
  <p>
    Built with
    <a
      href="https://gohugo.io"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Hugo</a
    >
    and
    <a
      href="https://github.com/apvarun/showfolio-hugo-theme"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Showfolio</a
    >
  </p>
</footer>

</body>
</html>
