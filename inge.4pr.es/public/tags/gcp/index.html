<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>
    gcp - inge4pres
  </title><meta name="generator" content="Hugo 0.98.0" /><link
    rel="stylesheet"
    href="https://inge.4pr.es/css/styles.css"
    integrity=""
  />
  
  <script>
    
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>
  
</head>

  <body
    class="flex flex-col min-h-screen dark:bg-gray-900 dark:text-gray-100 transition-colors duration-500"
  ><header class="w-full px-4 pt-4 max-w-5xl mx-auto">
  <nav class="flex items-center justify-between flex-wrap">
    <div class="flex gap-2 items-center">
      
      <a href="mailto:fgualazzi@gmail.com" aria-label="EMail">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <circle cx="12" cy="12" r="4" />
          <path d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28" />
        </svg>
      </a>
      
      <a href="https://inge.4pr.es/" class="flex items-center font-bold">
        inge4pres
      </a>
    </div>

    <ul id="nav-menu" class="flex w-auto mt-0 space-x-2">
      
      <li>
        <a href="https://inge.4pr.es/about/" class="hover:text-blue-800 dark:hover:text-blue-300">You are what you is (F. Zappa)</a>
      </li>
      
      
      <li>
        <a href="https://inge.4pr.es/categories/blog/" class="hover:text-blue-800 dark:hover:text-blue-300">blog</a>
      </li>
      
    </ul>
  </nav>
</header>
<main class="flex-1 mx-4 md:mx-12 lg:mx-24 mt-8 sm:mt-16"> 
<article class="sm:mx-12 mb-16 prose lg:prose-lg">
  <h1><a href="https://inge.4pr.es/post/2017-10-01-getting-started-with-google-cloud-builder/">Getting Started With Google Cloud Builder</a></h1>
  <p>One of the advantages of containerized applications is the standardization, some would say &ldquo;write it once, runs everywhere&rdquo; but that&rsquo;s another motto for another product. Anyway with a new packaging technology the same problems are faced: build reproducibility, or the necessity for people doing Ops to know they are going to deploy the same exact piece of code the Dev team used in their tests. So to address this issue the container image needs to be immutable: once it&rsquo;s built, it&rsquo;s not going to be changed, ever. And the same image will be used for testing, QA, beta, preview, presales-demo, whatever environment you need to deploy the app to.</p>
<h4 id="building-it">Building it</h4>
<p>Docker has been around for a few years now, it&rsquo;s mature and stable, but ask anyone using it if they&rsquo;d allow images built on development workstation to run in production: not gonna happen! The artifact that will serve production traffic will pass through the CI/CD pipelines and pushed to the registry, this is the way of shipping containers. &ldquo;That&rsquo;s easy&rdquo;, you&rsquo;ll say, &ldquo;I&rsquo;ll stick my Dockerfile in the repo and let the build system do the magic!&rdquo;, but that&rsquo;s not the whole picture: there are lower layers to pull, tests to be run and <em>only after they succeed</em> you can build the container. So who is going to maintain all of this configurations? Can we store them into the repo too? Yes! With GCB you can write a declarative multi-step workflow that will compile, test and package the code in a container; the container will get immediately pushed to the Google Container Registry too, so it&rsquo;s ready to be consumed (maybe Kubernetes on GKE?).</p>
<h4 id="a-simple-application">A simple application</h4>
<p>There is quite a good number of examples in the <a href="https://github.com/GoogleCloudPlatform/cloud-builders" title="GCB on Github">cloud builder repository</a> but I&rsquo;d like to create a fresh one with Golang: a random number generator. The app will serve a random integer via HTTP, and you can see the code is <a href="https://github.com/inge4pres/blog/blob/master/getting-started-with-google-cloud-builder/main.go">very straightforward</a>.
Now I want to build a container to run into GCP with confidence so that every time I make a build I will have a new container image tagged with the version and ready to roll it out.</p>
<h4 id="using-gcb">Using GCB</h4>
<p>All builds in GCB happen in a container, right now the only engine supported is Docker but more are going to be added. You can leverage Google pre-baked builders or use your own images as builders, in the example I am using Google&rsquo;s <code>golang-project</code> image to compile and <code>docker</code> to build the final docker image and push it to registry. Note how some environment variables are injected to the container, like <code>PROJECT_ID</code> is your GCP running project as configured via</p>
<pre tabindex="0"><code>gcloud auth login
gcloud config set project your-gcp-project
</code></pre><h5 id="_side-note-for-gophers_"><em>Side note for gophers</em></h5>
<p>The <code>golang-project</code> image does some checks at setup to determine the workspace structure: there need to be a <code>./src</code> folder or <code>GOPATH</code> must be passed, or the simplest way is to <a href="https://github.com/inge4pres/blog/blob/master/getting-started-with-google-cloud-builder/main.go#L1">insert a comment next to <code>package main</code> in <code>main.go</code></a></p>
<h4 id="running-the-build">Running the build</h4>
<p>It&rsquo;s as easy as executing</p>
<pre tabindex="0"><code>gcloud container builds submit --config cloudbuild.yaml .
</code></pre><p>in the root of your project.</p>
<p>See it in action!</p>
<!-- raw HTML omitted -->
<p>As you can see the current folder (<code>.</code> as last parameter) is compressed and shipped to a Cloud Storage random location, then GCB starts the steps listed in the configuration YAML file, running step by step the containers with their arguments.</p>
<h4 id="conclusion">Conclusion</h4>
<p>GCB is fast and very easy to use but for what I&rsquo;ve been able to test is bound to GCP right now, so if you are willing to deliver a service from Google Cloud and your application is containerized or <em>&ldquo;cloud native&rdquo;</em> you have a lightweight build system ready to go, but if you have a private registry or other integrations to do, GCB might still be a too small niche.</p>
<p>I&rsquo;ll make more tests and try to hack a bit GCB in the future so stay tuned!</p>

</article>
 
    </main><footer class="w-full text-center p-4 text-xs text-gray-400">
  <p>
    Built with
    <a
      href="https://gohugo.io"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Hugo</a
    >
    and
    <a
      href="https://github.com/apvarun/showfolio-hugo-theme"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Showfolio</a
    >
  </p>
</footer>

</body>
</html>
