<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>
    Cloud-native applications: Operator-Framework - inge4pres
  </title>
  <meta name="author" content="inge4pres" />
  <meta name="generator" content="Hugo 0.98.0" /><link
    rel="stylesheet"
    href="https://inge.4pr.es/css/styles.css"
    integrity=""
  />
  
  <script>
    
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>
  
</head>

  <body
    class="flex flex-col min-h-screen dark:bg-gray-900 dark:text-gray-100 transition-colors duration-500"
  ><header class="w-full px-4 pt-4 max-w-5xl mx-auto">
  <nav class="flex items-center justify-between flex-wrap">
    <div class="flex gap-2 items-center">
      
      <a href="mailto:fgualazzi@gmail.com" aria-label="EMail">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <circle cx="12" cy="12" r="4" />
          <path d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28" />
        </svg>
      </a>
      
      <a href="https://inge.4pr.es/" class="flex items-center font-bold">
        inge4pres
      </a>
    </div>

    <ul id="nav-menu" class="flex w-auto mt-0 space-x-2">
      
      <li>
        <a href="https://inge.4pr.es/about/" class="hover:text-blue-800 dark:hover:text-blue-300">You are what you is (F. Zappa)</a>
      </li>
      
      
      <li>
        <a href="https://inge.4pr.es/categories/blog/" class="hover:text-blue-800 dark:hover:text-blue-300">blog</a>
      </li>
      
    </ul>
  </nav>
</header>
<main class="flex-1 mx-4 md:mx-12 lg:mx-24 mt-8 sm:mt-16">
<article class="mb-16 max-w-5xl mx-auto px-4 prose lg:prose-lg prose-blue dark:prose-dark">
  <h1>Cloud-native applications: Operator-Framework</h1>
  <p><strong>Cloud-native</strong>: sounds attractive right? What does it even mean? <a href="https://en.wikipedia.org/wiki/Cloud-native">Wikipedia</a> has no page on it already so anyone can give its own definition&hellip; Here&rsquo;s mine:</p>
<p><em>A Cloud-native application has only concern on the functionalities that it has to deliver as it is completely decoupled from the infrastructure it runs on</em></p>
<p>So how can software delivery be cloud-native? Isn&rsquo;t software delivery supposed to &ldquo;install&rdquo; software onto some infrastructure? Well if your infrastructure provider <em>is</em> cloud-native, you can transitively deliver software on it in a cloud-native way (counts of cloud-native is over 9000, so stopping here)!</p>
<p>Recently RedHat acquired CoreOS, bold move if you ask me. CoreOS since the M&amp;A has been very quite until a week ago when the <a href="https://github.com/operator-framework">operator-framework</a> was announced through a <a href="https://coreos.com/blog/introducing-operator-framework">blog post</a>; this is a huge step forward for everyone as this new toolkit will empower the average developer with the ability to run operators on Kubernetes and package their applications as extensions to the Kubernetes API.</p>
<p>Never heard of <a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/#customresourcedefinitions">Custom Resource Definitions</a>? You&rsquo;d better get on track as this will be driving the next-gen wave of applications that will run <em>as part</em> of the platform that delivers them, with the ability to automate their management and simplify dramatically their operations which will be tightly integrated with the cluster management itself.</p>
<p>And as usual I&rsquo;m eager to try out this new toy and see what can be done with it: I want to build a cloud-native software delivery application that will enable CI/CD jobs to be running inside the cluster and managed by the same API server! Using a CRD for the &ldquo;Pipeline&rdquo; kind I can control the build/test/release flow of my application and moreover monitor the whole thing with the same tools with which I will monitor my application.</p>
<h3 id="creating-cd">Creating CD³</h3>
<p>I decided to start a new project called <a href="https://github.com/inge4pres/cdkube">CD³ (cd kube)</a>: it will be a Continuous-* software that will run in Kubernetes and will be dedicated to deliver software <em>through</em> Kubernetes. I found Weaveworks did something similar with <a href="https://github.com/weaveworks/flux/">Flux</a> and since I don&rsquo;t want to reinvent the wheel I&rsquo;ll just try and replicate some functionality of running a continer in an operator.</p>
<p>First things first: I installed the <a href="https://github.com/operator-framework/operator-sdk">operator-sdk</a> and I have the binary in my <code>$GOPATH/bin</code>.
Running</p>
<pre tabindex="0"><code>$GOPATH/bin/operator-sdk new cdkube --api-version=delivery.inge.4pr.es/v1alpha1 --kind=Pipeline
</code></pre><p>I am resulting in an auto-generated project with some scaffold code, as in <a href="https://github.com/inge4pres/cdkube/commit/bd7a1cf8790cf02169057f759e40272993673181">this commit</a>.
Next I add some details which I think are at the core of a pipeline: the repository with code and configurations, the image to build the software and what version/name give to the resulting application artifact. When adding new items to the Spec and Status of CRD I will modify the <a href="https://github.com/inge4pres/cdkube/blob/master/pkg/apis/delivery/v1alpha1/types.go">pkg/apis/delivery/v1alpha1/types.go</a> file, then the guide suggests to run <code>operator-sdk generate k8s</code> to update the code, in fact the <code>zz_generated_deepcopy.go</code> is updated, but I don&rsquo;t see the <a href="https://github.com/inge4pres/cdkube/commit/5a17429d206475bcef85077d1f9aeb6fdda50357#diff-5cd8fbaa4e3fbb473c3e57c6fabca2f9">deploy/cr.yaml</a> changed as it should so probably there&rsquo;s a bug&hellip; Moving forward I have my operator logic to be defined now: I add some check whether the building pod is succeded and build the operator</p>
<pre tabindex="0"><code>operator-sdk build inge4pres/cdkube:v0.0.1
docker push inge4pres/cdkube:v0.0.1
</code></pre><p>My operator is built, pushed to dockerhub and ready to be kicked in a k8s cluster, so I fire up one in GKE</p>
<pre tabindex="0"><code>gcloud beta container --project &#34;inge4pres-gcp&#34; clusters create &#34;operator-framework-test&#34; --zone &#34;europe-west1-b&#34; --machine-type &#34;g1-small&#34; --image-type &#34;COS&#34; --disk-size &#34;25&#34;

gcloud container clusters get-credentials operator-framework-test --zone europe-west1-b --project inge4pres-gcp
</code></pre><p>and when it&rsquo;s ready I can deploy the auto-generated resources to the cluster.
An amazing result is that once the depoloyment is done I can create my CRD with the <code>kubectl</code> command and see my custom-type declared, running <code>kubectl create -f deploy/crd.yaml</code> I have a new object created in k8s</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  ~ kubectl get pipeline
</span></span><span style="display:flex;"><span>NAME            AGE
</span></span><span style="display:flex;"><span>doing-nothing   16s
</span></span><span style="display:flex;"><span>➜  ~ kubectl describe pipeline
</span></span><span style="display:flex;"><span>Name:         doing-nothing
</span></span><span style="display:flex;"><span>Namespace:    default
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>API Version:  delivery.inge.4pr.es/v1alpha1
</span></span><span style="display:flex;"><span>Kind:         Pipeline
</span></span><span style="display:flex;"><span>Metadata:
</span></span><span style="display:flex;"><span>  Cluster Name:
</span></span><span style="display:flex;"><span>  Creation Timestamp:             2018-05-05T18:08:31Z
</span></span><span style="display:flex;"><span>  Deletion Grace Period Seconds:  &lt;nil&gt;
</span></span><span style="display:flex;"><span>  Deletion Timestamp:             &lt;nil&gt;
</span></span><span style="display:flex;"><span>  Initializers:                   &lt;nil&gt;
</span></span><span style="display:flex;"><span>  Resource Version:               <span style="color:#bd93f9">1528</span>
</span></span><span style="display:flex;"><span>  Self Link:                      /apis/delivery.inge.4pr.es/v1alpha1/namespaces/default/pipelines/doing-nothing
</span></span><span style="display:flex;"><span>  UID:                            5160a990-508f-11e8-8f06-42010a8401f8
</span></span><span style="display:flex;"><span>Spec:
</span></span><span style="display:flex;"><span>Spec:
</span></span><span style="display:flex;"><span>  Build Arguments:
</span></span><span style="display:flex;"><span>    building something...
</span></span><span style="display:flex;"><span>    now I&#39;m <span style="color:#ff79c6">done</span>
</span></span><span style="display:flex;"><span>  Build Commands:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">echo</span>
</span></span><span style="display:flex;"><span>  Build Image:     busybox
</span></span><span style="display:flex;"><span>  Repo:            http://github.com/inge4pres/just-a-test
</span></span><span style="display:flex;"><span>  Target Name:     tesApp
</span></span><span style="display:flex;"><span>  Target Version:  0.1
</span></span><span style="display:flex;"><span>Events:            &lt;none&gt;
</span></span><span style="display:flex;"><span>➜  ~</span></span></code></pre></div>
<p>When I deploy my operator and create the custom resource applying the manifest for a pipeline, the operator picks it up and starts a container with the name of the pipeline</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl apply -f deploy/cr.yaml
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl get po
</span></span><span style="display:flex;"><span>NAME                      READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>cdkube-57bcf65584-sbvd6   1/1       Running   <span style="color:#bd93f9">0</span>          12s
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl apply -f deploy/cr.yaml
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f1fa8c">&#34;doing-nothing&#34;</span> created
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl get po
</span></span><span style="display:flex;"><span>NAME                      READY     STATUS              RESTARTS   AGE
</span></span><span style="display:flex;"><span>cdkube-57bcf65584-sbvd6   1/1       Running             <span style="color:#bd93f9">0</span>          29s
</span></span><span style="display:flex;"><span>testapp                   0/1       ContainerCreating   <span style="color:#bd93f9">0</span>          2s
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl logs cdkube-57bcf65584-sbvd6
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:42:59Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Go Version: go1.10.2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:42:59Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Go OS/Arch: linux/amd64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:42:59Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;operator-sdk Version: 0.0.5+git&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:42:59Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;starting pipelines controller&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;2018-05-05T18:43:21Z&#34;</span> <span style="color:#8be9fd;font-style:italic">level</span><span style="color:#ff79c6">=</span>info <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;build still running, status of builder container: Pending&#34;</span>
</span></span><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl get po
</span></span><span style="display:flex;"><span>NAME                      READY     STATUS      RESTARTS   AGE
</span></span><span style="display:flex;"><span>cdkube-57bcf65584-sbvd6   1/1       Running     <span style="color:#bd93f9">0</span>          49s
</span></span><span style="display:flex;"><span>testapp                   0/1       Completed   <span style="color:#bd93f9">2</span>          22s</span></span></code></pre></div>
<p>and if I get the <code>testapp</code> logs I can see the pipeline execution</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  cdkube git:<span style="color:#ff79c6">(</span>master<span style="color:#ff79c6">)</span> ✗ kubectl logs testapp
</span></span><span style="display:flex;"><span>building something... now I&#39;m <span style="color:#ff79c6">done</span></span></span></code></pre></div>
<p>Bonus: if the custom resource is deleted with <code>kubectl delete -f deploy/cr.yaml</code> the pod <code>testapp</code> gets terminated automatically! I don&rsquo;t know if this magic is done by Kubernetes or by the Operator Framework, but sure I love it as it will enable my resources to be managed with the k8s API just like any other.</p>
<p>I still need to tune the logic of handling the container as I didn&rsquo;t expect the restarts to happen, but hey this looks amazing! In a couple of hours I have an operator that can spawn containers when instructed to do so by custom manifests representing a pipeline!</p>
<p>Stay tuned 😎</p>

</article>

    </main><footer class="w-full text-center p-4 text-xs text-gray-400">
  <p>
    Built with
    <a
      href="https://gohugo.io"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Hugo</a
    >
    and
    <a
      href="https://github.com/apvarun/showfolio-hugo-theme"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Showfolio</a
    >
  </p>
</footer>

</body>
</html>
