

lego --email="${email}" --domains="${domain}" --domains="${san}" --dns="route53" --path $HOME/.lego renew

aws iam upload-server-certificate --server-certificate-name ${today}-cf-${domain} --certificate-body file://$HOME/.lego/certificates/4pr.es.crt --private-key file://$HOME/.lego/certificates/4pr.es.key --path /cloudfront/inge4pres/ > upload-output.txt
#{
#    "ServerCertificateMetadata": {
#        "ServerCertificateId": "ASCAITMERTVMVZIKZV7NQ",
#        "ServerCertificateName": "20161127-cf-4pr.es",
#        "Expiration": "2017-02-25T14:04:00Z",
#        "Path": "/cloudfront/inge4pres/",
#        "Arn": "arn:aws:iam::295665577671:server-certificate/cloudfront/inge4pres/20161127-cf-4pr.es",
#        "UploadDate": "2016-11-27T15:08:47.567Z"
#    }
#}


### Update items
aws apigateway update-domain-name --domain-name ${domain} --patch-operations op='replace',path='/certificateName',value='/cloudfront/inge4pres/${today}-cf-${domain}'

aws cloudfront get-distribution-config --id ${cf_id} > CF_config_${cf_id}.json
CERTID=$(cat upload-output.txt | jq -rc .ServerCertificateMetadata.ServerCertificateId)
cat CF_config_${cf_id} | jq --arg CERTID $CERTID '.DistributionConfig.ViewerCertificate.IAMCertificateId |= $CERTID' \
   | jq --arg CERTID $CERTID '.DistributionConfig.ViewerCertificate.Certificate |= $CERTID' > CF_config_update_${cf_id}.json
   
aws cloudfront update-distribution --distribution-config file://CF_config_update_${cf_id}.json --id ${cf_id}
