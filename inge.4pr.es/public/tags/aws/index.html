<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>
    aws - inge4pres
  </title><meta name="generator" content="Hugo 0.98.0" /><link
    rel="stylesheet"
    href="https://inge.4pr.es/css/styles.css"
    integrity=""
  />
  
  <script>
    
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>
  
</head>

  <body
    class="flex flex-col min-h-screen dark:bg-gray-900 dark:text-gray-100 transition-colors duration-500"
  ><header class="w-full px-4 pt-4 max-w-5xl mx-auto">
  <nav class="flex items-center justify-between flex-wrap">
    <div class="flex gap-2 items-center">
      
      <a href="mailto:fgualazzi@gmail.com" aria-label="EMail">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <circle cx="12" cy="12" r="4" />
          <path d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28" />
        </svg>
      </a>
      
      <a href="https://inge.4pr.es/" class="flex items-center font-bold">
        inge4pres
      </a>
    </div>

    <ul id="nav-menu" class="flex w-auto mt-0 space-x-2">
      
      <li>
        <a href="https://inge.4pr.es/about/" class="hover:text-blue-800 dark:hover:text-blue-300">You are what you is (F. Zappa)</a>
      </li>
      
      
      <li>
        <a href="https://inge.4pr.es/categories/blog/" class="hover:text-blue-800 dark:hover:text-blue-300">blog</a>
      </li>
      
    </ul>
  </nav>
</header>
<main class="flex-1 mx-4 md:mx-12 lg:mx-24 mt-8 sm:mt-16"> 
<article class="sm:mx-12 mb-16 prose lg:prose-lg">
  <h1><a href="https://inge.4pr.es/post/2016-12-03-automate-tls-management-on-aws-with-letsencrypt/">Automate TLS management on AWS with LetsEncrypt</a></h1>
  <p>Letsencrypt is cool: automated, free TLS certificates for everybody! They are sponsored mainly by internet corps and they started a crowd-funding campaign to avoid the influence of this corps in the future of the project. I recently moved the blog to hugo on AWS and I&rsquo;m now porting the TLS management scripts I wrote a while ago on AWS: this is a nice exercise to give a proper TLS automation valid for everyone on AWS.</p>
<p>I used <a href="https://terraform.io" title="terraform">Terraform</a>, the AWS CLI and the amazing (although still in beta) <a href="https://github.com/xenolf/lego" title="lego">lego</a>; the idea is to spin up an EC2 instance every month to query Letsencrypt to renew a  certificate I already provisioned; the instance will have permissions to update the certificate using <a href="https://aws.amazon.com/certificate-manager/" title="aws acm">AWS Certificate Manager</a> and other services like API Gateway custom domain names and Cloudfront are already bound to use ACM certificate of the domain. I tried and make the Terraform code as abstract and reusable as possible: cloudfront distribution id, domain name and issuer mail are all variable configurable via config file or at command line.</p>
<h4 id="setting-up-the-environment">Setting up the environment</h4>
<p>I prepared the TLS certificate and key running first lego once on my local box, using the DNS challenge against AWS Route53, lego will use Letsencrypt ACME secret and put it into a TXT record for the domain to be validated so that Letsencrypt will know I am the owner of the domain. You can read more on Letsencrypt domain ownership validation <a href="https://letsencrypt.org/how-it-works/" title="Letsencrypt how it works">here</a>.</p>
<p>After the lego account is created, generally in <code>$HOME/.lego</code>, you will find private key and certificate is created for the domain(s); the certificate is a bundle of all the SAN submitted in the request. Then how to automate all of this on AWS?</p>
<h4 id="designing-automation">Designing automation</h4>
<p>The idea is that every service that needs TLS encryption will be able to fetch the certificate from an AWS service. This was not possible until AWS Certificate Manager was released a while ago: ACM will create or store a certificate to be used in other AWS services via the AWS API. No more magic to spread certificates via S3 or other tricks, you now have an <code>awscli</code> command!
So here I chose to use Terraform to bootstrap all the infrastructure to run lego and run Letsencrypt automatically via AWS Autoscaling group.</p>
<p>I first imported the certificate created with lego in ACM in us-east-1 region (N. Virginia): this is due to API Gateway limitations to be able to integrate natively with ACM only in us-east-1. I get the certificate ARN for the certificate just uploaded and I run <code>terraform plan -var 'cf_distribution_id=EX4MPL3D15TR0' -var 'certificate_arn=...'</code>.
Once completed I can see a new Autoscaling group with scheduled policies, a launch configuration that starting from the base Amazon AMI with a user-data script at each boot will:</p>
<ul>
<li>download and install lego binary</li>
<li>sync the TLS account with the S3 bucket created</li>
<li>split the certificate from the chain, as they need to be uploaded separately</li>
<li>call the <code>acm</code> subcommand of <code>awscli</code> to update the certificate</li>
</ul>
<p>This is amazing, I can now forget about TLS management for all of my websites!</p>

</article>

<article class="sm:mx-12 mb-16 prose lg:prose-lg">
  <h1><a href="https://inge.4pr.es/post/2016-09-18-a-benchmark-of-aws-efs/">A benchmark of AWS EFS</a></h1>
  <p>Amazon Web Services <!-- raw HTML omitted -->Elastic File System<!-- raw HTML omitted --> has been to my knowledge the service to have the longest beta testing period: reason for this may be that not as many client as expected tested it and AWS received too few feedback on it or that there were issues not to release GA. I don’t want to speculate on which one is correct but now that it has been <!-- raw HTML omitted -->officially released<!-- raw HTML omitted --> I decided to give it a try and of course compare it to a self-managed solution on the same platform.</p>
<p>If you followed AWS evolution you may agree that EFS has been introduced to fill the gap between EBS storage and S3: before EFS was live there was no “easy” way of having a distributed file system in AWS, you could only <!-- raw HTML omitted -->set up your own<!-- raw HTML omitted --> using  a combination of EC2 instances mounting Elastic Block Storage volumes and S3. Now with EFS you can have a AWS-managed distributed file system to be used in your cloud environment or even across the internet (will try that on a public subnet) with all the benefits of offloading the high-availability and replication burden to Amazon, and at a reasonable price. Will performance be enough compared to a self-managed solution?</p>
<h5 id="playground">Playground</h5>
<p>I use <!-- raw HTML omitted -->terraform<!-- raw HTML omitted --> to create an infrastructure template to run the tests, you can see it <!-- raw HTML omitted -->here<!-- raw HTML omitted -->. Once</p>
<!-- raw HTML omitted -->
<p>has finished, you’ll end up with:</p>
<ul>
<li>An EFS with General Purpose performance mode</li>
<li>An EFS mount target for 1 Availability Zone</li>
<li>1 EC2 instance named “client” to mount remote file systems</li>
<li>2 EC2 instances named “server_X” each one with a 10 GB General Purpose EBS, they will serve a self-managed distributed, replicated file system</li>
</ul>
<p>This is the terraform output and the steps to run on the 2 server nodes to have a running GlusterFS replicated volume; to configure the NFS export on server1, I used <!-- raw HTML omitted -->this guide<!-- raw HTML omitted -->.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>On the client I mount the EFS target with NFS4.1, the GlusterFS volume from the server <em>in the same subnet</em> via the GlusterFS native client_ _and the NFS export on the client’s designated mount points. I use the server on the same subnet as the client is, because the EFS target exposes a mount point in the same subnet and latency is a key factor in remote file system.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h5 id="benchmark-tests">Benchmark Tests</h5>
<p>I used <!-- raw HTML omitted -->fio<!-- raw HTML omitted --> installed on the client box with a command suggested by this <!-- raw HTML omitted -->BinaryLane post<!-- raw HTML omitted --> and run it against the mount point for EFS, GlusterFS and NFS v4.0 with the following command</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>changing the target directory each time I tun the test; each test is run isolated.</p>
<p>I did not customize any storage option for GlusterFS or NFS, so I’m using the default options.</p>
<h5 id="benchmarkresults">Benchmark Results</h5>
<h6 id="efs">EFS</h6>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h6 id="glusterfs">GlusterFS</h6>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h6 id="nfs-40-not-replicated">NFS 4.0 (not replicated)</h6>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h6 id="pricing-considerations">Pricing considerations</h6>
<p>EFS pricing is linear, you get billed a fixed amount for GB/month; this is not true with a self-managed cluster where you can surely reach higher performance, but the TCO is increasing every time you add capacity. If you’re not satisfied with EFS throughput you need a dedicated team to  manage a distributed file system cluster and its operations and maintenance.</p>
<h6 id="conclusions">Conclusions</h6>
<p>If you need a stable, realiable file system in AWS to be shared between EC2 instances, go and use EFS and don’t reinvent the wheel: GlusterFS is outperformed in both read and write IOPS and bandwith with the default options! The workload simulated here is showing poor write performance, so if your use case is a lot of concurrent writes on many files, consider another solution. A good workload could be a WORM (Write Once Read Many) share for permanent stored contents (images, archives?).</p>
<p>The performance are still low in absolute terms or compared to a non-replicated mount such as a stock NFS v4.0 server without the high-availability burden, but if you don’t care about 100% uptime you should definitely set up NFS with <!-- raw HTML omitted -->DRDB<!-- raw HTML omitted --> to a secondary node, and switch your mounts when the primary node fails. But still: why manage all of this if AWS can do it for you?</p>

</article>

<article class="sm:mx-12 mb-16 prose lg:prose-lg">
  <h1><a href="https://inge.4pr.es/post/2016-04-06-aws-iam-policy-to-let-users-manage-their-own-mfa/">AWS IAM policy to let users manage their own MFA</a></h1>
  <p>If you’re an AWS administrator you know that managing web console security is pretty tough unless you know what you want and you know what you’re doing. So if what you want is let each AWS user manage their own MFA device configuration without you and force them to have MFA active to use the web console, here is your solution.</p>
<p><strong>TL;DR</strong></p>
<ul>
<li>Create one or more groups with your web users</li>
<li>Create a new policy using <!-- raw HTML omitted -->this JSON<!-- raw HTML omitted --></li>
<li>Attach the policy to the group(s)</li>
</ul>
<p><strong>How does it work?</strong></p>
<p>The policy has this logic:</p>
<ul>
<li>Allow basic operations on IAM without having MFA set up</li>
<li>Allow setup and management of MFA for own user in IAM (create, delete, resync device)</li>
<li>Deny every action on every resource when MFA is not setup</li>
<li>Allow user to access IAM without MFA – this is necessary to sub-segment the previous rule</li>
</ul>
<p>The magic lies in the use of ARN policy variables which is a poorly documented feature of IAM. Notice how in some case the statement makes use of <code>${aws:username}</code> to confine the action executed on the only user receiving the policy grants.</p>
<p>This IAM policy blocks every serice usage when MFA is not setup, and in conjunction with default IAM behavior will deny access on every action if not explicitly given. You should combine this “base” policy with other group/service oriented policies to confine web users on certain functionalities. For example if you want a set of users self-managing their own MFA and access the EC2 service only after having setup MFA, you should execute the following after having setup the IAMUsersMFAManagement policy.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>``Reference: <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_variables.html">AWS IAM variables documentation</a></p>

</article>

<article class="sm:mx-12 mb-16 prose lg:prose-lg">
  <h1><a href="https://inge.4pr.es/post/2016-01-24-implement-a-generic-data-list-structure/">Implement a generic data list structure</a></h1>
  <p>As a coding challenge I was asked to provide a generic list implementation using a language of my choice and using only primitive types, avoiding the use of high level built-ins. I chose <!-- raw HTML omitted -->Go<!-- raw HTML omitted --> because I want to learn it and I know it can be useful to create an abstract, generic implementation.</p>
<p>The challenge request to implement at least 4 methods on the generic type:</p>
<ul>
<li>Filter() –  returns a subset of the List satisfying an operation</li>
<li>Map() – returns the List objects’ map</li>
<li>Reverse() – reverse the ordering of the List objects</li>
<li>FoldLeft() – join the objects from left to right using a join character</li>
</ul>
<p>As a bonus question I was asked to code unit tests for the aforementioned methods and give an explanation on how the implementation guarantees concurrent access on resources.</p>
<p>So here is my implementation: the type List has only one attribute, an array of type <code>interface{}</code></p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Every type will be convertible to the <code>interface{}</code> type, but as Golang has strong types the conversion is not implicit and must be declared.</p>
<p>Reverse() will create a new array of <code>interface{}</code> to hold the reversed list</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Map() returns the List elements’ array, so it can be accessed as a whole</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>This two function types will help define a custom operation to be used in Filter() and FoldLeft(): <!-- raw HTML omitted -->functions are types<!-- raw HTML omitted --> in Go and this enable a great level of abstraction.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Filter() will use a filter function, without the need to define it (!), and return a portion of the List data array.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>FoldLeft() will use a fold function, again not yet defined, the return a single element made of the entire list.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>You can find all the code <!-- raw HTML omitted -->here<!-- raw HTML omitted -->, any comment is welcome on how to improve the abstraction or efficiency of the implementation.</p>
<p>The opportunity to dig into the language ability to abstract is a very helpful way to better understand the language itself, so this coding challenge was a great opportunity to learn a little bit more Go!</p>

</article>
 
    </main><footer class="w-full text-center p-4 text-xs text-gray-400">
  <p>
    Built with
    <a
      href="https://gohugo.io"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Hugo</a
    >
    and
    <a
      href="https://github.com/apvarun/showfolio-hugo-theme"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Showfolio</a
    >
  </p>
</footer>

</body>
</html>
