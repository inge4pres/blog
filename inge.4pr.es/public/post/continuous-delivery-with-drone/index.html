<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>
    Continuous Delivery with Drone - inge4pres
  </title>
  <meta name="description" content="Getting started with a new CD tool based on containers" />
  
  <meta name="author" content="inge4pres" />
  <meta name="generator" content="Hugo 0.98.0" /><link
    rel="stylesheet"
    href="https://inge.4pr.es/css/styles.css"
    integrity=""
  />
  
  <script>
    
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>
  
</head>

  <body
    class="flex flex-col min-h-screen dark:bg-gray-900 dark:text-gray-100 transition-colors duration-500"
  ><header class="w-full px-4 pt-4 max-w-5xl mx-auto">
  <nav class="flex items-center justify-between flex-wrap">
    <div class="flex gap-2 items-center">
      
      <a href="mailto:fgualazzi@gmail.com" aria-label="EMail">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <circle cx="12" cy="12" r="4" />
          <path d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0 -5.5 8.28" />
        </svg>
      </a>
      
      <a href="https://inge.4pr.es/" class="flex items-center font-bold">
        inge4pres
      </a>
    </div>

    <ul id="nav-menu" class="flex w-auto mt-0 space-x-2">
      
      <li>
        <a href="https://inge.4pr.es/about/" class="hover:text-blue-800 dark:hover:text-blue-300">You are what you is (F. Zappa)</a>
      </li>
      
      
      <li>
        <a href="https://inge.4pr.es/categories/blog/" class="hover:text-blue-800 dark:hover:text-blue-300">blog</a>
      </li>
      
    </ul>
  </nav>
</header>
<main class="flex-1 mx-4 md:mx-12 lg:mx-24 mt-8 sm:mt-16">
<article class="mb-16 max-w-5xl mx-auto px-4 prose lg:prose-lg prose-blue dark:prose-dark">
  <h1>Continuous Delivery with Drone</h1>
  <p>Continuous Delivery should be a solved issue: the practice is well-defined and there is a plethora of tools implementing it with more or less peculiarities, but still many struggle implementing it. The dream of a perfect continuous deployment flow from the developer to the production environment with software quality gates based on automated tests is still alive in me, I tried and tried several times with multiple implementations on multiple platforms and never got to the point where I could say: &ldquo;I&rsquo;m done, this works exactly as I wanted&rdquo;.</p>
<p>So I stumbled on <a href="https://drone.io">drone</a> and decided to give it a go: it&rsquo;s an open-source project, written in Go and with a SaaS offering via their website. The concept I like is that every step of the build/deployment process runs through a container and this is very close to my idea of a modern CD tool, a platform where I can compose pipelines by chaining containers execution on a shared workspace. Love it already.</p>
<h3 id="installing-the-stack">Installing the stack</h3>
<p>You can run the drone server and agent locally on your laptop with <code>docker-compose</code> as detailed <a href="http://docs.drone.io/installation/">here</a>. Only issue is: for integrating with any of the big Git cloud provider (Github and Gitlab) you will need to expose your service to the internet, so I&rsquo;ll use a local instance of <a href="https://gogs.io/">gogs</a> running in a docker container from the <a href="https://github.com/gogits/gogs/tree/master/docker">official image</a>. All I need is in the <code>docker-compose.yml</code> file: I added just a couple of <code>volumes</code> directive compared to the <a href="http://docs.drone.io/install-for-gogs/">original one</a> and I am using the docker-for-mac internal hostname to resolve the bridge IP internally as detailed <a href="https://docs.docker.com/docker-for-mac/networking/#use-cases-and-workarounds">here</a>. This is a lab setup and having a production-ready installation will require database setup and filesystem persistence, but I don&rsquo;t have this requirement now. After a <code>docker-compose up -d</code> my stack is ready.</p>
<h4 id="installing-the-cli">Installing the CLI</h4>
<p>As easy as following <a href="http://docs.drone.io/cli-installation/">this guide</a>. Once logged to the web UI I navigate to the <code>${DRONE_HOST}/account/token</code> page where I can get a token to configure the CLI.</p>
<h3 id="adding-secrets">Adding secrets</h3>
<p>There is a nice feature in drone: I can <a href="http://docs.drone.io/manage-secrets/">manage secrets</a> directly from the command line and they can be scoped globally or be available only to one pipeline step (corresponding to an image). I will need to add Dockerhub username and password to the <code>plugin/docker</code> image to be able to push the image, so I add this 2 secrets with the following</p>
<pre tabindex="0"><code>drone secret add -repository=inge/goapp -image=plugins/docker -name=docker_username -value=inge4pres
drone secret add -repository=inge/goapp -image=plugins/docker -name=docker_password -value=***************
</code></pre><h3 id="a-sample-pipeline">A sample pipeline</h3>
<p>As many of the continuous delivery tools available on the market, drone uses a YAML configuration file in the root of the repository, so adding a <code>.drone.yml</code> hidden file is enough to start hooking every commit to the build system. I configured a <a href="https://github.com/inge4pres/blog/blob/master/continuous-delivery-with-drone/test-app/.drone.yml">3 stages pipeline</a>:</p>
<ul>
<li>test and build artifact</li>
<li>publish the artifact</li>
<li>deploy the application</li>
</ul>
<p>It&rsquo;s very simple to get started and the one-container-per-step architecture makes it trivial to glue together multiple steps. There is an implicit concept of <a href="http://docs.drone.io/workspace/">shared workspace (configurable)</a> that you can leverage to use Makefile and Dockerfile just as the build was happening on your local environment.</p>
<p>So I really recommend trying out drone and reporting some issues if you find any, for the time being I am very excited to have a CD product entirely written in Go - I think I will contribute to the project to have some enhancements available in the free version.</p>
<p>Below here some screenshots of the drone web UI and the pipeline resulting from the YAML config file: I will explore more complex workflows like <a href="http://docs.drone.io/promoting-builds/">promoted builds</a> and <a href="http://docs.drone.io/gated-builds/">gated builds</a> - and build more in the tool if I need.</p>
<figure><img src="https://raw.githubusercontent.com/inge4pres/blog/master/continuous-delivery-with-drone/screenshots/drone-local.jpeg"/><figcaption>
            <h4>drone repository view</h4>
        </figcaption>
</figure>

<figure><img src="https://raw.githubusercontent.com/inge4pres/blog/master/continuous-delivery-with-drone/screenshots/drone-detail.jpeg"/><figcaption>
            <h4>drone pipeline log</h4>
        </figcaption>
</figure>

<figure><img src="https://raw.githubusercontent.com/inge4pres/blog/master/continuous-delivery-with-drone/screenshots/drone-error.jpeg"/><figcaption>
            <h4>drone stage error</h4>
        </figcaption>
</figure>

<figure><img src="https://raw.githubusercontent.com/inge4pres/blog/master/continuous-delivery-with-drone/screenshots/drone-running.jpeg"/><figcaption>
            <h4>drone running</h4>
        </figcaption>
</figure>


</article>

    </main><footer class="w-full text-center p-4 text-xs text-gray-400">
  <p>
    Built with
    <a
      href="https://gohugo.io"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Hugo</a
    >
    and
    <a
      href="https://github.com/apvarun/showfolio-hugo-theme"
      target="_blank"
      rel="noopener noreferrer"
      class="underline hover:text-blue-800 dark:hover:text-blue-300"
      >Showfolio</a
    >
  </p>
</footer>

</body>
</html>
