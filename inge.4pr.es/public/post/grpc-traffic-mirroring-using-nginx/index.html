<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="noodp"/><title>gRPC Traffic Mirroring Using NGINX - INGE4PRES RATIONAL THOUGHTS</title>
        <meta name="twitter:card" content="summary_large_image"/><meta name="twitter:creator" content="@inge4pres"/><meta name="twitter:title" content=""/>
        <meta name="twitter:description" content="Francesco Gualazzi: infrastructure-aware developer"/>
        <meta name="Description" content="An NGINX configuration trick to mirror traffic to gRPC backends"><meta property="og:title" content="gRPC Traffic Mirroring Using NGINX" />
<meta property="og:description" content="An NGINX configuration trick to mirror traffic to gRPC backends" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://inge.4pr.es/post/grpc-traffic-mirroring-using-nginx/" /><meta property="og:image" content="https://inge.4pr.es/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-30T17:23:35+02:00" />
<meta property="article:modified_time" content="2021-05-30T17:23:35+02:00" />

<meta name="application-name" content="INGE4PRES RATIONAL THOUGHTS">
<meta name="apple-mobile-web-app-title" content="INGE4PRES RATIONAL THOUGHTS"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://inge.4pr.es/post/grpc-traffic-mirroring-using-nginx/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.6cf1ea52f3eaa1db6fd80fb0ba96e8568d6d83a847d1c35cce0f61aad5b2416b.css" integrity="sha256-bPHqUvPqodtv2A&#43;wupboVo1tg6hH0cNczg9hqtWyQWs="><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><meta name="google-site-verification" content="TOk-oj9FYpVoRqq2BjvXT_OWQZZ6poZhp1WZXPhfMvE" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "gRPC Traffic Mirroring Using NGINX",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/inge.4pr.es\/post\/grpc-traffic-mirroring-using-nginx\/"
        },"image": ["https:\/\/inge.4pr.es\/images\/avatar.png"],"genre": "post","keywords": "SRE, infrastructure","wordCount":  1245 ,
        "url": "https:\/\/inge.4pr.es\/post\/grpc-traffic-mirroring-using-nginx\/","datePublished": "2021-05-30T17:23:35+02:00","dateModified": "2021-05-30T17:23:35+02:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","description": "An NGINX configuration trick to mirror traffic to gRPC backends"
    }
    </script><script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "https:\/\/inge.4pr.es\/"
        },{
            "@type": "ListItem",
            "position": 2,
            "name": "tech",
            "item": "https://inge.4pr.es/categories/tech/"
        },{
                "@type": "ListItem",
                "position": 3,
                "name": "gRPC Traffic Mirroring Using NGINX"
            }]
    }
</script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header>
    <div class="desktop header" id="header-desktop">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="INGE4PRES RATIONAL THOUGHTS" class="header-logo logo-svg"><img loading="lazy" decoding="async"
         class="logo"
         src="/images/gopher.png"
         alt="/images/gopher.png"
         title="/images/gopher.png"
    /><span class="header-title-pre"><i class='fas fa-pencil-alt fa-fw'></i></span>INGE4PRES RATIONAL THOUGHTS<span class="header-title-post">ü§ì <i class='fas fa-pencil-alt fa-fw'>Growing knowledge one post at a time</i></span></a>
            </div>
            <div class="menu">
                <nav>
                    <h2 class="display-hidden">–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è</h2>
                    <ul class="menu-inner"><li>
                            <a class="menu-item" href="/about/"> About </a>
                        </li><li>
                            <a class="menu-item" href="/resume/"> Resume </a>
                        </li><li>
                            <a class="menu-item" href="/tags/"> Tags </a>
                        </li></ul>
                </nav><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Find" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <span class="svg-icon icon-search"></span>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <span class="svg-icon icon-cancel"></span>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <span class="svg-icon icon-loading"></span>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <span class="svg-icon icon-moon"></span>
                </a>
            </div>
        </div>
    </div><div class="mobile header" id="header-mobile">
        <div class="header-container">
            <div class="header-wrapper">
                <div class="header-title">
                    <a href="/" title="INGE4PRES RATIONAL THOUGHTS" class="header-logo"><img loading="lazy" decoding="async"
         class="logo"
         src="/images/gopher.png"
         alt="/images/gopher.png"
         title="/images/gopher.png"
    /><span class="header-title-pre"><i class='fas fa-pencil-alt fa-fw'></i></span>INGE4PRES RATIONAL THOUGHTS<span class="header-title-post">ü§ì <i class='fas fa-pencil-alt fa-fw'>Growing knowledge one post at a time</i></span></a>
                </div>
                <div class="menu-toggle" id="menu-toggle-mobile">
                    <span></span><span></span><span></span>
                </div>
            </div>
            <div class="menu" id="menu-mobile"><div class="search-wrapper">
                        <div class="search mobile" id="search-mobile">
                            <input type="text" placeholder="Find" id="search-input-mobile">
                            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                                <span class="svg-icon icon-search"></span>
                            </a>
                            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                                <span class="svg-icon icon-cancel"></span>
                            </a>
                            <span class="search-button search-loading" id="search-loading-mobile">
                                <span class="svg-icon icon-loading"></span>
                            </span>
                        </div>
                        <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                            Cancel
                        </a>
                    </div><nav>
                    <h2 class="display-hidden">–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è</h2>
                    <ul><li>
                            <a class="menu-item" href="/about/" title="">About</a>
                        </li><li>
                            <a class="menu-item" href="/resume/" title="">Resume</a>
                        </li><li>
                            <a class="menu-item" href="/tags/" title="">Tags</a>
                        </li></ul>
                </nav>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <span class="svg-icon icon-moon"></span>
                </a></div>
        </div>
    </div><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div></header><main class="main">
                <div class="container"><div class="page single special"><h1 class="single-title pulse faster">gRPC Traffic Mirroring Using NGINX</h1><h2 class="single-subtitle">Unveiling the power of mirror, grpc and proxy modules</h2><div class="content" id="content"><p>Recently at work with the <a href="https://optimyze.cloud" target="_blank" rel="noopener noreffer">Optimyze</a> team we faced the necessity of copying traffic from our current customer-facing environment to a new environment.
We have assumptions and ideas about architectural changes that cannot be validated only with synthetic tests and require cloning traffic to a separate, internal testing environment.</p>
<p>There is no better test than the one performed with real-world data: when you hear speaking about <em>testing in production</em>, a deployment of a new feature to &ldquo;see what happens&rdquo; is not what I have in mind.
I think of techniques that allow testing <em>with</em> production such as traffic mirroring (or <em>shadowing</em>), canary releases, A/B testing and feature flags.</p>
<p>These techniques will allow gathering data directly from your customers, in the form of raw input data (web/API requests) or feedback recorded from customers' interaction with a new product version.</p>
<p>In the case of traffic mirroring we don&rsquo;t introduce any changes to a production system, we simply copy the traffic (entirely or a portion of it) into a different system, for internal analysis.
When applying this technique, security considerations apply: you do not want to leak customers data into a non-production system,
so ensure you apply the same security policies to the shadow infrastructure receiving a copy of production traffic.</p>
<h3 id="tldr" class="headerLink"><a href="#tldr" class="header-mark"></a>TL;DR</h3><p><strong>If you&rsquo;re in a rush and don&rsquo;t care about the details, the solution is <a href="#the-solution" rel="">here</a>.</strong></p>
<h3 id="the-problem" class="headerLink"><a href="#the-problem" class="header-mark"></a>The problem</h3><p>We ‚ô• NGINX!
We knew it has the ability to serve as <a href="https://www.nginx.com/blog/nginx-1-13-10-grpc/" target="_blank" rel="noopener noreffer">reverse proxy for gRPC services</a>,
and it has <a href="https://nginx.org/en/docs/http/ngx_http_mirror_module.html" target="_blank" rel="noopener noreffer">built-in support for mirroring</a>.</p>
<p>What we didn&rsquo;t know is that mirroring gRPC traffic has a caveat: URI rewrite is not possible within the <code>grpc_pass</code> directive.
This means that traffic copied over to a new location (as described in the mirroring module docs) will have an URI set with the mirror location, making the service unable to map it with any RPC when received.</p>
<h3 id="debugging-nginx-capabilities" class="headerLink"><a href="#debugging-nginx-capabilities" class="header-mark"></a>Debugging NGINX capabilities</h3><p>NGINX documentation is not very rich of examples or references to complex configurations, it is often left to the user
to build the desired outcome using the various building blocks offered by the modules.</p>
<p>In the case of traffic mirroring, the documentation states:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Sets the URI to which an original request will be mirrored. 
Several mirrors can be specified on the same configuration level.
</code></pre></td></tr></table>
</div>
</div><p>In first instance we thought we could simply copy directly the traffic together with <code>grpc_pass</code> in a naive configuration like the following (<strong>not working as intended!</strong>):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
	<span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>
	<span class="kn">server_name</span> <span class="s">grpc-backend.company.net</span><span class="p">;</span>
	<span class="kn">ssl_certificate</span> <span class="s">/etc/letsencrypt/live/company.net/fullchain.pem</span><span class="p">;</span>
	<span class="kn">ssl_certificate_key</span> <span class="s">/etc/letsencrypt/live/company.net/privkey.pem</span><span class="p">;</span>
	<span class="kn">root</span> <span class="s">/var/www/default</span><span class="p">;</span>
	
	<span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
		<span class="kn">mirror</span> <span class="s">/grpc-mirror</span><span class="p">;</span>
		<span class="kn">grpc_pass</span> <span class="s">grpc://production-upstream:12345</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kn">location</span> <span class="p">=</span> <span class="s">/grpc-mirror</span> <span class="p">{</span>
		<span class="kn">internal</span><span class="p">;</span>
		<span class="kn">grpc_pass</span> <span class="s">grpcs://mirror-upstream:443</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note 2 things here:</p>
<ul>
<li>we are using NGINX to do TLS termination and we have a production service listening at <code>production-upstream:12345</code> for unencrypted traffic</li>
<li>we are re-encrypting traffic when copying over to the mirror because we want to emulate the full end-to-end traffic that a client would generate, and that includes TLS termination</li>
</ul>
<p>This may not apply to you but I prefer to sponsor a secure-by-default configuration, you can get free and automated TLS certificates with <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreffer">LetsEncrypt</a>.</p>
<p>We noticed the shadow environment was not processing data, so it was time to enable some debugging and see what was happening.</p>
<p>We add some logging to help us troubleshoot what is going on.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx">	<span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
		<span class="kn">mirror</span> <span class="s">/grpc-mirror</span><span class="p">;</span>
		<span class="kn">grpc_pass</span> <span class="s">grpc://production-upstream:12345</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">location</span> <span class="p">=</span> <span class="s">/grpc-mirror</span> <span class="p">{</span>
		<span class="kn">internal</span><span class="p">;</span>
		<span class="kn">grpc_pass</span> <span class="s">grpcs://mirror-upstream:443</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">error_log</span> <span class="s">debug</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>We can now find these messages in the logs:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">2021/05/27 20:15:51 [debug] 15765#15765: *1 http upstream request: &#34;/grpc-mirror?&#34;
2021/05/27 20:15:51 [debug] 15765#15765: *1 grpc header: &#34;grpc-message: malformed method name: &#34;/grpc-mirror&#34;&#34;
</code></pre></td></tr></table>
</div>
</div><p>As documented, the <code>mirror-upstream</code> server receives a request with URI <code>/grpc-mirror</code>, making it useless on the receiving end and creating a path mismatch.</p>
<p>At this point we thought native gRPC mirroring was not possible with NGINX and we tried to copy the traffic via the kernel network stack.</p>
<p>So we introduced a new server on a different port, willing to direct there the traffic <em>outside</em> of NGINX.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
	<span class="kn">listen</span> <span class="mi">9443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>

	<span class="kn">ssl_certificate</span> <span class="s">/etc/letsencrypt/live/company.net/fullchain.pem</span><span class="p">;</span>
	<span class="kn">ssl_certificate_key</span> <span class="s">/etc/letsencrypt/live/company.net/privkey.pem</span><span class="p">;</span>
	<span class="kn">root</span> <span class="s">/var/www/default</span><span class="p">;</span>
	<span class="kn">server_name</span> <span class="s">grpc-backend.company.net</span><span class="p">;</span>

	<span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
		<span class="kn">grpc_pass</span> <span class="s">grpcs://mirror-upstream:443</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
	<span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>

	<span class="kn">ssl_certificate</span> <span class="s">/etc/letsencrypt/live/company.net/fullchain.pem</span><span class="p">;</span>
	<span class="kn">ssl_certificate_key</span> <span class="s">/etc/letsencrypt/live/company.net/privkey.pem</span><span class="p">;</span>
	<span class="kn">root</span> <span class="s">/var/www/default</span><span class="p">;</span>
	<span class="kn">server_name</span> <span class="s">grpc-backend.company.net</span><span class="p">;</span>

	<span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
		<span class="kn">grpc_pass</span> <span class="s">grpc://production-upstream:12345</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When we thought about cloning raw TCP traffic we also had to include TLS termination for the cloned traffic.</p>
<p>With this we are thinking we&rsquo;ll keep the same desired testing properties because the traffic will be cloned without NGINX knowing it,
so we tried with iptables rules using the <code>TEE</code> target only to realize minutes later that cloning TCP packets simply does not work because the protocol
is stateful and there is no way for the kernel to handle duplicated responses from a second client that has never been tracked.</p>
<p>Using a separate server is key to the correct solution presented below (thanks <a href="https://twitter.com/mejofi" target="_blank" rel="noopener noreffer">@mejofi</a> for the brilliant idea).</p>
<h3 id="the-solution" class="headerLink"><a href="#the-solution" class="header-mark"></a>The solution</h3><p>The trick is to combine the gRPC module with the proxy module to achieve the URI rewrite that is needed.</p>
<p>Here is a working gRPC traffic mirroring configuration:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
	<span class="kn">listen</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>
	
	<span class="kn">ssl_certificate</span> <span class="s">/etc/letsencrypt/live/company.net/fullchain.pem</span><span class="p">;</span>
	<span class="kn">ssl_certificate_key</span> <span class="s">/etc/letsencrypt/live/company.net/privkey.pem</span><span class="p">;</span>
	<span class="kn">root</span> <span class="s">/var/www/default</span><span class="p">;</span>
	<span class="kn">server_name</span> <span class="s">grpc-backend.company.net</span><span class="p">;</span>

	<span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
		<span class="kn">grpc_pass</span> <span class="s">grpcs://mirror-upstream:443</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
	<span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>

	<span class="kn">ssl_certificate</span> <span class="s">/etc/letsencrypt/live/company.net/fullchain.pem</span><span class="p">;</span>
	<span class="kn">ssl_certificate_key</span> <span class="s">/etc/letsencrypt/live/company.net/privkey.pem</span><span class="p">;</span>
	<span class="kn">root</span> <span class="s">/var/www/default</span><span class="p">;</span>
	<span class="kn">server_name</span> <span class="s">grpc-backend.company.net</span><span class="p">;</span>

	<span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
		<span class="kn">mirror</span> <span class="s">/grpc-mirror</span><span class="p">;</span>
		<span class="kn">grpc_pass</span> <span class="s">grpc://production-upstream:12345</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="kn">location</span> <span class="p">=</span> <span class="s">/grpc-mirror</span> <span class="p">{</span>
		<span class="kn">internal</span><span class="p">;</span>
		<span class="kn">proxy_pass</span> <span class="s">https://127.0.0.1:9443</span><span class="nv">$request_uri</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>In the snippets, the definition of upstream servers has been omitted.</strong> The configuration is not valid without them!</p>
<p>What we have here:</p>
<ul>
<li>the second server now listens on the loopback interface to avoid traffic leaving the NIC</li>
<li>the un-encrypted traffic is mirrored to an <code>internal</code> location</li>
<li>a <code>proxy_pass</code> directive that will set the original URI in the next upstream, proxying the traffic the loopback server</li>
<li>the <code>grpc_pass</code> in the loopback server will re-encrypt and pass the request to the shadow environment, but with the right gRPC path URI</li>
</ul>
<p><strong>Pay attention</strong>: the previous configuration will copy <em>all traffic</em> from a production gRPC service into a shadow environment.</p>
<p>It is left as an exercise to the reader to find the proper way of shadowing only a portion of the traffic (hint: check the
<a href="https://nginx.org/en/docs/http/ngx_http_split_clients_module.html" target="_blank" rel="noopener noreffer">split_clients_module</a>).</p>
<p>A further improvement could be to use a UNIX socket for the server that will proxy requests to <code>mirror-upstream</code>,
on some OSes it might be faster than TCP proxying. I didn&rsquo;t test it yet but it looks like a possible combination offered
by <code>listen</code> and <code>proxy_pass</code> (the URI rewrite <em>should</em> be possible).</p>
<h3 id="conclusions" class="headerLink"><a href="#conclusions" class="header-mark"></a>Conclusions</h3><p>Traffic mirroring is a key enabler for so many scenarios that it should be a first class citizen in any major webserver, for every protocol.</p>
<p>NGINX configuration can be treated as an art, given the infinite possibilities the server offers with its modularity.</p>
<p>I hope this post will save you some hours of debugging and will increase your testing capabilities,
I decided to write it because I could not find a complete answer online do the question: &ldquo;can NGXIN mirror gRPC traffic?&rdquo;.
And the answer is &ldquo;yes&rdquo;!</p>
</div><div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></div></div>
                </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.88.0">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://inge.4pr.es/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target="_blank" title="uBlogger 2.0.1">uBlogger</a>
                </div><div class="footer-line"><i class="svg-icon icon-copyright"></i><span>2012 - 2021</span><span class="author">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <aside id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="svg-icon icon-arrow-up"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="svg-icon icon-comments-fixed"></i>
            </a>
        </aside><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><script src="https://inge4pres.disqus.com/embed.js" defer></script><script src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js"></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"cookieconsent":{"content":{"dismiss":"LGTM","link":"Learn more","message":"Do you like cookies?"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":20,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script src="/js/theme.min.0d44909075b648ac3259c39fcf9ddb2a6e7314cb3a7374007dd582c887381740.js" integrity="sha256-DUSQkHW2SKwyWcOfz53bKm5zFMs6c3QAfdWCyIc4F0A="></script><script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	        ga('create', 'UA-55252403-1', 'auto');
	        ga('set', 'anonymizeIp', true);
	        ga('send', 'pageview');
	    </script></body>
</html>
